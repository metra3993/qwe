{% extends 'base.html' %}

{% block title %}–ö–æ—Ä–∑–∏–Ω–∞ - FreshMarket{% endblock %}

{% block content %}
<div class="container py-5">
    <h1 class="mb-4">üõí –ö–æ—Ä–∑–∏–Ω–∞</h1>

    {% if cart_items %}
        <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 24px; align-items: start;">
            <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
            <div>
                {% for item in cart_items %}
                    <div class="card mb-3" id="cart-item-{{ item.id }}">
                        <div class="card-body">
                            <div class="d-flex gap-3">
                                <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ -->
                                <div style="flex-shrink: 0;">
                                    {% if item.product.main_image %}
                                        <img src="{{ item.product.main_image.image.url }}" alt="{{ item.product.name }}"
                                             style="width: 100px; height: 100px; object-fit: cover; border: 1px solid var(--color-border);">
                                    {% else %}
                                        <div style="width: 100px; height: 100px; background: var(--color-hover); display: flex; align-items: center; justify-content: center; border: 1px solid var(--color-border);">
                                            <span style="font-size: 48px;">{{ item.product.category.icon }}</span>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–¥—É–∫—Ç–µ -->
                                <div style="flex-grow: 1;">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <p class="text-sm text-secondary mb-1">{{ item.product.category.icon }} {{ item.product.category.name }}</p>
                                            <h3 style="margin-bottom: 4px;">{{ item.product.name }}</h3>
                                            {% if item.product.brand %}
                                                <p class="text-sm text-secondary">{{ item.product.brand }}</p>
                                            {% endif %}
                                        </div>
                                        <form method="post" action="{% url 'orders:remove_from_cart' item.id %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn-icon" title="–£–¥–∞–ª–∏—Ç—å">
                                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M2.5 5h15M8.333 9.167v5M11.667 9.167v5M3.333 5l.834 11.667c0 .916.75 1.666 1.666 1.666h8.334c.916 0 1.666-.75 1.666-1.666L16.667 5M7.5 5V3.333c0-.916.75-1.666 1.667-1.666h1.666c.917 0 1.667.75 1.667 1.666V5"/>
                                                </svg>
                                            </button>
                                        </form>
                                    </div>

                                    <!-- –¶–µ–Ω–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ -->
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div class="quantity-control">
                                            <button type="button" class="quantity-btn" onclick="updateQuantity({{ item.id }}, -1)">‚àí</button>
                                            <input type="number"
                                                   id="quantity-{{ item.id }}"
                                                   value="{{ item.quantity }}"
                                                   min="1"
                                                   max="{{ item.product.stock }}"
                                                   onchange="updateQuantityDirect({{ item.id }}, this.value)"
                                                   style="width: 60px; text-align: center; border: 1px solid var(--color-border); padding: 8px;">
                                            <button type="button" class="quantity-btn" onclick="updateQuantity({{ item.id }}, 1)">+</button>
                                        </div>
                                        <div>
                                            <p class="card-price" id="item-total-{{ item.id }}">{{ item.total_price|floatformat:0 }} ‚ÇΩ</p>
                                            <p class="text-sm text-secondary">{{ item.product.price|floatformat:0 }} ‚ÇΩ / {{ item.product.get_unit_display }}</p>
                                        </div>
                                    </div>

                                    {% if item.quantity >= item.product.stock %}
                                        <p class="text-sm text-secondary mt-2" style="color: #ff6b6b;">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}

                <form method="post" action="{% url 'orders:clear_cart' %}" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm" style="color: #ff6b6b;">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
                </form>
            </div>

            <!-- –ò—Ç–æ–≥–æ -->
            <div class="card" style="position: sticky; top: 80px;">
                <div class="card-body">
                    <h3 class="mb-4">–í–∞—à –∑–∞–∫–∞–∑</h3>

                    <div class="order-summary">
                        <div class="summary-row">
                            <span class="text-secondary">–¢–æ–≤–∞—Ä–æ–≤:</span>
                            <span id="cart-items-count">{{ cart.total_items }} —à—Ç</span>
                        </div>

                        <div class="summary-row">
                            <span class="text-secondary">–°—É–º–º–∞ —Ç–æ–≤–∞—Ä–æ–≤:</span>
                            <strong id="cart-total-price">{{ cart.total_price|floatformat:0 }} ‚ÇΩ</strong>
                        </div>

                        <div class="summary-row">
                            <span class="text-secondary">–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                            {% if cart.total_price >= 500 %}
                                <strong id="delivery-price">99 ‚ÇΩ</strong>
                            {% else %}
                                <span class="text-secondary text-sm">–û—Ç 500 ‚ÇΩ</span>
                            {% endif %}
                        </div>

                        <div class="summary-divider"></div>

                        <div class="summary-row summary-total">
                            <span style="font-size: 18px; font-weight: 600;">–ò—Ç–æ–≥–æ:</span>
                            {% if cart.total_price >= 500 %}
                                <span style="font-size: 24px; font-weight: 600; color: var(--color-accent);" id="cart-final-total">{{ cart.total_price|add:99|floatformat:0 }} ‚ÇΩ</span>
                            {% else %}
                                <span style="font-size: 24px; font-weight: 600; color: var(--color-accent);" id="cart-final-total">{{ cart.total_price|floatformat:0 }} ‚ÇΩ</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- –í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ -->
                    <div class="delivery-info">
                        <div class="delivery-info-header">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            <span style="font-weight: 500;">–î–æ—Å—Ç–∞–≤–∫–∞</span>
                        </div>
                        <p class="text-sm text-secondary" style="margin: 8px 0 0 0;">–°–µ–≥–æ–¥–Ω—è —Å 18:00 –¥–æ 22:00</p>
                        <p class="text-sm" style="margin: 4px 0 0 0; color: var(--color-accent);">–∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏</p>
                    </div>

                    <!-- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑ -->
                    {% if cart.total_price < 500 %}
                        <div class="minimum-order-notice">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="12"/>
                                <line x1="12" y1="16" x2="12.01" y2="16"/>
                            </svg>
                            <span>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ 500 ‚ÇΩ</span>
                        </div>
                        <div class="progress-bar-container">
                            {% widthratio cart.total_price 500 100 as progress_percent %}
                            <div class="progress-bar" style="width: {{ progress_percent }}%"></div>
                        </div>
                        <p class="text-sm text-secondary text-center" style="margin-top: 8px;">
                            {% with remaining=500|add:cart.total_price|floatformat:0 %}
                                –î–æ–±–∞–≤—å—Ç–µ –µ—â—ë —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ <strong>{{ remaining|slice:"1:" }} ‚ÇΩ</strong>
                            {% endwith %}
                        </p>
                    {% endif %}

                    {% if cart.total_price >= 500 %}
                        <a href="{% url 'orders:checkout' %}" class="btn btn-primary btn-block mb-2" style="margin-top: 20px;">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</a>
                    {% else %}
                        <button class="btn btn-primary btn-block mb-2" style="margin-top: 20px; opacity: 0.5; cursor: not-allowed;" disabled>–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
                    {% endif %}
                    <a href="{% url 'products:catalog' %}" class="btn btn-block">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</a>

                    <!-- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ -->
                    <div class="benefits">
                        <div class="benefit-item">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                            <span class="text-sm">–°–≤–µ–∂–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã</span>
                        </div>
                        <div class="benefit-item">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                <line x1="1" y1="10" x2="23" y2="10"/>
                            </svg>
                            <span class="text-sm">–û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏</span>
                        </div>
                        <div class="benefit-item">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="8.5" cy="7" r="4"/>
                                <polyline points="17 11 19 13 23 9"/>
                            </svg>
                            <span class="text-sm">–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <!-- –ü—É—Å—Ç–∞—è –∫–æ—Ä–∑–∏–Ω–∞ -->
        <div class="text-center py-5">
            <div style="font-size: 80px; margin-bottom: 24px;">üõí</div>
            <h2 class="mb-3">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h2>
            <p class="text-secondary mb-4">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞</p>
            <a href="{% url 'products:catalog' %}" class="btn btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥</a>
        </div>
    {% endif %}
</div>

<style>
.quantity-control {
    display: flex;
    align-items: center;
    gap: 0;
}

.quantity-btn {
    width: 36px;
    height: 36px;
    border: 1px solid var(--color-border);
    background: var(--color-background);
    cursor: pointer;
    font-size: 18px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.quantity-btn:hover {
    background: var(--color-hover);
    color: var(--color-accent);
}

.quantity-btn:first-child {
    border-right: none;
}

.quantity-btn:last-child {
    border-left: none;
}

.btn-icon {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    color: var(--color-secondary);
    transition: color 0.2s;
}

.btn-icon:hover {
    color: #ff6b6b;
}

/* Order Summary */
.order-summary {
    margin-bottom: 20px;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.summary-divider {
    height: 1px;
    background: var(--color-border);
    margin: 16px 0;
}

.summary-total {
    margin-top: 16px;
}

/* Delivery Info */
.delivery-info {
    background: var(--color-hover);
    padding: 16px;
    border-radius: 4px;
    margin: 20px 0;
    border-left: 3px solid var(--color-accent);
}

.delivery-info-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}

/* Minimum Order Notice */
.minimum-order-notice {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px;
    background: #fff8e1;
    border: 1px solid #ffd54f;
    border-radius: 4px;
    margin: 16px 0 12px 0;
    font-size: 14px;
    color: #f57c00;
}

.progress-bar-container {
    width: 100%;
    height: 8px;
    background: var(--color-border);
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--color-accent), var(--color-accent-hover));
    transition: width 0.3s ease;
}

/* Benefits */
.benefits {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--color-border);
}

.benefit-item {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.benefit-item:last-child {
    margin-bottom: 0;
}
</style>

<script>
function updateQuantity(itemId, change) {
    const input = document.getElementById(`quantity-${itemId}`);
    const currentValue = parseInt(input.value);
    const maxValue = parseInt(input.max);
    const newValue = currentValue + change;

    if (newValue >= 1 && newValue <= maxValue) {
        updateQuantityDirect(itemId, newValue);
    }
}

function updateQuantityDirect(itemId, quantity) {
    const formData = new FormData();
    formData.append('quantity', quantity);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch(`/orders/cart/update/${itemId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É –ø–æ–∑–∏—Ü–∏–∏
            if (data.item_total > 0) {
                document.getElementById(`item-total-${itemId}`).textContent = Math.round(data.item_total) + ' ‚ÇΩ';
                document.getElementById(`quantity-${itemId}`).value = quantity;
            } else {
                // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ 0
                document.getElementById(`cart-item-${itemId}`).remove();

                // –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                if (data.cart_items_count === 0) {
                    location.reload();
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—É–º–º—É
            const cartTotal = Math.round(data.cart_total);
            document.getElementById('cart-total-price').textContent = cartTotal + ' ‚ÇΩ';
            document.getElementById('cart-items-count').textContent = data.cart_items_count + ' —à—Ç';

            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π
            if (cartTotal >= 500) {
                document.getElementById('cart-final-total').textContent = (cartTotal + 99) + ' ‚ÇΩ';
            } else {
                document.getElementById('cart-final-total').textContent = cartTotal + ' ‚ÇΩ';
            }

            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –µ—Å–ª–∏ —Å—É–º–º–∞ –ø–µ—Ä–µ—à–ª–∞ —á–µ—Ä–µ–∑ –ø–æ—Ä–æ–≥ 500—Ä (—á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å UI)
            if ((cartTotal >= 500 && data.cart_total < 500) || (cartTotal < 500 && data.cart_total >= 500)) {
                location.reload();
            }
        }
    })
    .catch(error => console.error('Error:', error));
}
</script>
{% endblock %}
